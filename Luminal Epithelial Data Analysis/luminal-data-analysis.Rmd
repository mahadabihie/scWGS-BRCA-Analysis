---
title: "luminal-data-analysis"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    code_folding: hide
---

# **Info**
## *Library*
```{r message=FALSE, warning=FALSE}
#install.packages("openxlsx")
library(openxlsx)
#install.packages("tidyverse")
library(tidyverse)
#install.packages("dplyr")
library(dplyr)
#install.packages("ggplot2")
library(ggplot2)
#install.packages("kableExtra")
library(kableExtra)
#install.packages("data.table")
library(data.table)
#install.packages("dplyr")
library(dplyr)
#install.packages("ggplot2")
library(ggplot2)
#install.packages("ggnewscale")
library(ggnewscale)
#install.packages("vroom")
library(vroom)
```

# **Generating Data**
## *Read in BRCA1 & BRCA2 Deletions*
```{r message=FALSE, warning=FALSE}
#set your data directory
data_dir <- "~/brca-new/own data/"

#list all TSV files that match the naming pattern
tsv_files <- list.files(path = data_dir, pattern = "^cnv_exon_overlaps_.*\\.tsv$", full.names = TRUE)

#create a named list of data frames, using file identifiers (e.g., B1.43) as names
overlap_data_list <- setNames(
  lapply(tsv_files, read_tsv),
  nm = gsub("^cnv_exon_overlaps_|\\.tsv$", "", basename(tsv_files))
)

#combine specific data frames into one
gn.del <- bind_rows(
  overlap_data_list$B1.43,
  overlap_data_list$B1.49,
  overlap_data_list$B1.6410,
  overlap_data_list$B1.6537,
  overlap_data_list$B1.6548,
  overlap_data_list$B1.6550,
  overlap_data_list$B2.6532,
  overlap_data_list$B2.18,
  overlap_data_list$B2.25,
  overlap_data_list$B2.16,
  overlap_data_list$B2.21,
  overlap_data_list$B2.23,
  overlap_data_list$WT.6,
  overlap_data_list$WT.62,
  overlap_data_list$WT.6752
)


#organize b2 samples by tissue type (show tumor progression ALH-LCIS-DCIS)
gn.del$sample <- factor(gn.del$sample, levels = c(
  "B1.43", "B1.49", "B1.6410", "B1.6537", "B1.6548", "B1.6550",
  "B2.6532","B2.18", "B2.25", "B2.16", "B2.21", "B2.23",
  "WT.6", "WT.62", "WT.6752"))

#reorder tissue levels
overlap <- gn.del %>%
  mutate(tissue = factor(tissue, levels = c("benign", "ALH", "LCIS", "DCIS")))

#del only
overlap <- overlap %>% filter(state < 2)
```

## *CND: generating data*
```{r message=FALSE, warning=FALSE}
process_Deletions <- function(file_path) {
  #read in data
  data <- read.csv(file_path)
  
  #filter for Deletions
  Deletions <- data %>%
    filter(state < 2) 
  
  #read in sample info
  cancer.history <- read.xlsx("~/brca-new/Williams et al./williams-samples.xlsx")
  cancer.history <- cancer.history %>% 
    rename(sample = "patient_id",
           cancer = current_past_cancer.in.contralateral.breast,
           tissue = Final.Path.Diagnosis) %>%
    dplyr::select(sample, chemo, cancer, tissue)
  
  #edit sample info
  cancer.history$chemo <- gsub("N/A", "no chemo", cancer.history$chemo) 
  cancer.history$chemo <- gsub("N", "no chemo", cancer.history$chemo) 
  cancer.history$chemo <- gsub("Y", "chemo", cancer.history$chemo) 
  cancer.history$tissue <- gsub("R:", "", cancer.history$tissue) 
  cancer.history$tissue <- gsub("R: ", "", cancer.history$tissue) 
  cancer.history$tissue <- gsub("L: ", "", cancer.history$tissue)
  cancer.history$tissue <- gsub(" UDH", "", cancer.history$tissue)
  cancer.history$tissue <- gsub(" cysts", "", cancer.history$tissue)
  cancer.history$tissue <- gsub(" non-proliferative", "", cancer.history$tissue)
  cancer.history$tissue <- gsub(" ", "", cancer.history$tissue)


  #add sample info to df
  Deletions <- Deletions %>%
    left_join(cancer.history, by = "sample")
  
  #add genotype for B1 or B2
  Deletions <- Deletions %>%
    mutate(genotype = ifelse(grepl("B1-6548", sample), 
                             "B1/B2", sub("-.*", "", sample)))
  
  #edit sample name
  Deletions$sample <- gsub("-", ".", Deletions$sample)
  
  #summarize state
  Deletions <- Deletions %>%
    group_by(cell_id) %>%
    mutate(length = (as.numeric(end) - as.numeric(start)) / 1e6) %>%
    mutate(sum.length = sum(length)) %>%
    distinct(cell_id, .keep_all = TRUE) %>% #filter so each cell has 1 row
    dplyr::select(cell_id, sample, genotype,  chemo, cancer, tissue, start, end, state, sum.length)
  
  #extract the name from a column (e.g., sample_id)
  if ("sample" %in% colnames(Deletions)) {
    df_name <- unique(Deletions$sample)[1]  #take the first unique value
  } else {
    df_name <- tools::file_path_sans_ext(basename(file_path))  #use filename if column not present
  }
  
  
  assign(df_name, Deletions, envir = .GlobalEnv)  #save dataframe to global environment
  
  return(df_name)  #return the name of the dataframe
}

#list of files
files <- c(
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B1HET43-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B1HET49-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B1HET6410-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B1HET6537-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B1HET6548-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B1HET6550-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B2HET16-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B2HET18-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B2HET21-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B2HET23-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B2HET25-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B2HET6532-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/WT6-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/WT62-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/WT6752-hscn.csv"
)

#run multiple files through function
df_names <- lapply(files, process_Deletions)  #process and store names

#combine dfs
df.cnd <- rbind(B1.43, B1.49, B1.6410, B1.6537, B1.6548, B1.6550, B2.16, B2.18, B2.21, B2.23, B2.25,
                 B2.6532, WT.6, WT.62, WT.6752)

#organize b2 samples by tissue
df.cnd$sample <- factor(df.cnd$sample, levels = c(
  "B1.43", "B1.49", "B1.6410", "B1.6537", "B1.6548", "B1.6550",
  "B2.6532","B2.18", "B2.25", "B2.16", "B2.21", "B2.23",
  "WT.6", "WT.62", "WT.6752"))
```

## *CNA: generating data*
```{r message=FALSE, warning=FALSE}
process_amplifications <- function(file_path) {
  #read in data
  data <- read.csv(file_path)
  
  #filter for amplifications
  amplifications <- data %>%
    filter(state > 2) 
  
  #read in sample info
  cancer.history <- read.xlsx("~/brca-new/Williams et al./williams-samples.xlsx")
  cancer.history <- cancer.history %>% 
    rename(sample = "patient_id",
           cancer = current_past_cancer.in.contralateral.breast,
           tissue = Final.Path.Diagnosis) %>%
    dplyr::select(sample, chemo, cancer, tissue)
  
  #edit sample info
  cancer.history$chemo <- gsub("N/A", "no chemo", cancer.history$chemo) 
  cancer.history$chemo <- gsub("N", "no chemo", cancer.history$chemo) 
  cancer.history$chemo <- gsub("Y", "chemo", cancer.history$chemo) 
  cancer.history$tissue <- gsub("R:", "", cancer.history$tissue) 
  cancer.history$tissue <- gsub("R: ", "", cancer.history$tissue) 
  cancer.history$tissue <- gsub("L: ", "", cancer.history$tissue)
  cancer.history$tissue <- gsub(" UDH", "", cancer.history$tissue)
  cancer.history$tissue <- gsub(" cysts", "", cancer.history$tissue)
  cancer.history$tissue <- gsub(" non-proliferative", "", cancer.history$tissue)
  cancer.history$tissue <- gsub(" ", "", cancer.history$tissue)


  #add sample info to df
  amplifications <- amplifications %>%
    left_join(cancer.history, by = "sample")
  
  #add genotype for B1 or B2
  amplifications <- amplifications %>%
    mutate(genotype = ifelse(grepl("B1-6548", sample), 
                             "B1/B2", sub("-.*", "", sample)))
  
  #edit sample name
  amplifications$sample <- gsub("-", ".", amplifications$sample)
  
  #summarize state
  amplifications <- amplifications %>%
    group_by(cell_id) %>%
    mutate(length = (as.numeric(end) - as.numeric(start)) / 1e6) %>%
    mutate(sum.length = sum(length)) %>%
    distinct(cell_id, .keep_all = TRUE) %>% #filter so each cell has 1 row
    dplyr::select(cell_id, sample, genotype,  chemo, cancer, tissue, start, end, state, sum.length)
  
  #extract the name from a column (e.g., sample_id)
  if ("sample" %in% colnames(amplifications)) {
    df_name <- unique(amplifications$sample)[1]  #take the first unique value
  } else {
    df_name <- tools::file_path_sans_ext(basename(file_path))  #use filename if column not present
  }
  
  
  assign(df_name, amplifications, envir = .GlobalEnv)  #save dataframe to global environment
  
  return(df_name)  #return the name of the dataframe
}

#list of files
files <- c(
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B1HET43-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B1HET49-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B1HET6410-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B1HET6537-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B1HET6548-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B1HET6550-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B2HET16-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B2HET18-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B2HET21-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B2HET23-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B2HET25-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/B2HET6532-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/WT6-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/WT62-hscn.csv",
  "/Users/mahadbihie/brca-new/data_directory/allele_specific_cn/WT6752-hscn.csv"
)

#run multiple files through function
df_names <- lapply(files, process_amplifications)  #process and store names

#combine dfs
df.cna <- rbind(B1.43, B1.49, B1.6410, B1.6537, B1.6548, B1.6550, B2.16, B2.18, B2.21, B2.23, B2.25,
                 B2.6532, WT.6, WT.62, WT.6752)

#organize b2 samples by tissue
df.cna$sample <- factor(df.cna$sample, levels = c(
  "B1.43", "B1.49", "B1.6410", "B1.6537", "B1.6548", "B1.6550",
  "B2.6532","B2.18", "B2.25", "B2.16", "B2.21", "B2.23",
  "WT.6", "WT.62", "WT.6752"))
```

# **Plots**
## *Deletion Plot*
```{r, warning=FALSE, message=FALSE}
#set classification flags
brca2_cells <- unique(overlap$cell_id[overlap$gene == "BRCA2"])
brca1_cells <- unique(overlap$cell_id[overlap$gene == "BRCA1"])

#add classification to plotting data
plot_del <- df.cnd %>%
  mutate(
    has_brca2 = cell_id %in% brca2_cells,
    has_brca1 = cell_id %in% brca1_cells,
    gene_deletion_status = case_when(
      has_brca1 & has_brca2 ~ "BRCA1 + BRCA2 del",
      has_brca1 ~ "BRCA1 del",
      has_brca2 ~ "BRCA2 del",
      TRUE ~ "No del"
    )
  )

#set factor levels for legend order
plot_del$gene_deletion_status <- factor(
  plot_del$gene_deletion_status,
  levels = c("BRCA1 + BRCA2 del", "BRCA1 del", "BRCA2 del", "No del")
)

#set levels for plot order
plot_del$genotype <- factor(
  plot_del$genotype,
  level = c("B1", "B2", "B1/B2", "WT")
)

#edit plot settings
text_size <- 40
axis_text_angle <- 48

#build plot
brca_del_MB_plot <- ggplot(plot_del, aes(x = sample, y = sum.length)) +

  #violin plots
  geom_violin(aes(fill = tissue), scale = "width", adjust = 1.5) +

  #reset fill scale
  ggnewscale::new_scale_fill() +

  #points: shape by chemo, fill by gene deletion status
  geom_point(
    data = subset(plot_del, gene_deletion_status != "No del"),
    aes(
      x = sample,
      y = sum.length,
      fill = gene_deletion_status,
      shape = chemo
    ),
    color = "black",
    position = position_jitter(width = 0.2, height = 0.1),
    size = 10,
    stroke = 0.7
  ) +

  #fill colors for gene deletion status
  scale_fill_manual(
    name = "Gene Deletion Status",
    values = c(
      "BRCA1 + BRCA2 del" = "green",  
      "BRCA1 del" = "yellow",         
      "BRCA2 del" = "purple"          
    ),
    guide = guide_legend(override.aes = list(
      shape = 21,
      color = "black",
      size = 5,
      stroke = 0.7
    ))
  ) +

  #shape legend for chemo status
  scale_shape_manual(
    name = "Chemo Status",
    values = c("chemo" = 21, "no chemo" = 22)  #adjust to match your data
  ) +
  
  #median point
  stat_summary(fun = median, geom = "point", color = "black", size = 4, shape = 18) +
  
  #log Y-axis
  scale_y_log10(limits = c(1, NA), breaks = c(1, 10, 100, 1000)) +
  
  #labels
  labs(
    title = "SCNA Deletion Burden",
    x = "Genotype",
    y = "MB Affected"
  ) +
  
  #theme tweaks
  theme_minimal(base_size = text_size) +
  theme(
    legend.position =  "right",
    legend.title = element_text(size = 32),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "lines"),
    legend.spacing.x = unit(0.5, 'cm'),
    plot.title = element_text(face = "bold", size = text_size + 2, hjust = 0.5),
    axis.title.x = element_blank(),
    axis.title.y = element_text(face = "bold", size = text_size),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 30),
    axis.text.y = element_text(size = text_size - 6),
    panel.border = element_rect(fill = NA, color = "black", size = 1),
    strip.background = element_rect(fill = "grey90", color = "black", size = 1),
    panel.spacing = grid::unit(1, "lines")
  ) +
facet_wrap(~ genotype, scales = "free_x", ncol = 4)

#save plot
ggsave("~/brca-new/plots/brca_del_MB_plot_luminal.png", plot = brca_del_MB_plot, width = 29, height = 18, bg = "white", limitsize = FALSE)
```

## *Amplification Plot*
```{r, warning=FALSE, message=FALSE}
#set classification flags
brca2_cells <- unique(overlap$cell_id[overlap$gene == "BRCA2"])
brca1_cells <- unique(overlap$cell_id[overlap$gene == "BRCA1"])

#add classification to plotting data
plot_amp <- df.cna %>%
  #filter(genotype != "B1/B2") %>%
  mutate(
    has_brca2 = cell_id %in% brca2_cells,
    has_brca1 = cell_id %in% brca1_cells,
    gene_deletion_status = case_when(
      has_brca1 & has_brca2 ~ "BRCA1 + BRCA2 del",
      has_brca1 ~ "BRCA1 del",
      has_brca2 ~ "BRCA2 del",
      TRUE ~ "No del"
    )
  )

#set factor levels for legend order
plot_amp$gene_deletion_status <- factor(
  plot_amp$gene_deletion_status,
  levels = c("BRCA1 + BRCA2 del", "BRCA1 del", "BRCA2 del", "No del")
)

#edit plot settings
text_size <- 40
axis_text_angle <- 48

#build plot
brca_amp_MB_plot <- ggplot(plot_amp, aes(x = sample, y = sum.length)) +

  # Violin plots
  geom_violin(aes(fill = tissue), scale = "width", adjust = 1.5) +

  # Reset fill scale
  ggnewscale::new_scale_fill() +

  # Points: shape by chemo, fill by gene deletion status
  geom_point(
    data = subset(plot_amp, gene_deletion_status != "No del"),
    aes(
      x = sample,
      y = sum.length,
      fill = gene_deletion_status,
      shape = chemo
    ),
    color = "black",
    position = position_jitter(width = 0.2, height = 0.1),
    size = 10,
    stroke = 0.7
  ) +

  #fill colors for gene deletion status
  scale_fill_manual(
    name = "Gene Deletion Status",
    values = c(
      "BRCA1 + BRCA2 del" = "green",  
      "BRCA1 del" = "yellow",         
      "BRCA2 del" = "purple"          
    ),
    guide = guide_legend(override.aes = list(
      shape = 21,
      color = "black",
      size = 5,
      stroke = 0.7
    ))
  ) +

  # Shape legend for chemo status
  scale_shape_manual(
    name = "Chemo Status",
    values = c("chemo" = 21, "no chemo" = 22)  # Adjust to match your data
  ) +
  
  #median point
  stat_summary(fun = median, geom = "point", color = "black", size = 4, shape = 18) +
  
  #log Y-axis
  scale_y_log10(limits = c(1, NA), breaks = c(1, 10, 100, 1000)) +
  
  # Labels
  labs(
    title = "SCNA Gain Burden",
    x = "Genotype",
    y = "MB Affected"
  ) +
  
  #theme tweaks
  theme_minimal(base_size = text_size) +
  theme(
    legend.position =  "right",
    legend.title = element_text(size = 32),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "lines"),
    legend.spacing.x = unit(0.5, 'cm'),
    plot.title = element_text(face = "bold", size = text_size + 2, hjust = 0.5),
    axis.title.x = element_blank(),
    axis.title.y = element_text(face = "bold", size = text_size),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 30),
    axis.text.y = element_text(size = text_size - 6),
    panel.border = element_rect(fill = NA, color = "black", size = 1),
    strip.background = element_rect(fill = "grey90", color = "black", size = 1),
    panel.spacing = grid::unit(1, "lines")
  ) +
facet_wrap(~ genotype, scales = "free_x", ncol = 4)

# Save plot
ggsave("~/brca-new/plots/brca_amp_MB_plot_luminal.png", plot = brca_amp_MB_plot, width = 29, height = 18, bg = "white", limitsize = FALSE)
```

# **Statistics**
## *% of cells with BRCA1 & BRCA2 Deletion* 
```{r}
#combine dfs
full.df <- rbind(plot_del, plot_amp)

#calculate proportions per patient
proportions_df <- full.df %>%
  group_by(genotype) %>%
  summarise(
    total_cells = n(),
    `BRCA1 del (%)` = sum(gene_deletion_status == "BRCA1 del") / total_cells * 100,
    `BRCA2 del (%)` = sum(gene_deletion_status == "BRCA2 del") / total_cells * 100
  ) %>%
  ungroup()

#create table
proportions_df  %>%
  kbl(caption = "% of 184-hTERT cells with BRCA1 & BRCA2 Deletion", digits = 10) %>%
  kable_classic(html_font = "Cambria") %>%
  kable_styling()
```

## *MFC: General Somatic BRCA Mutation*
```{r}
### DEL: Wilcoxon Test

#BRCA1 vs WT
b1 <- plot_del %>%
  filter(genotype == "B1", gene_deletion_status %in% c("BRCA1 del"))
wt <- plot_del %>%
  filter(genotype == "WT")

#wilcox test
w.del.b1.wt <- wilcox.test(b1$sum.length, wt$sum.length)
#w.del.b1.wt

#BRCA2 vs WT
b2 <- plot_del %>%
  filter(genotype == "B2", gene_deletion_status %in% c("BRCA2 del"))
wt <- plot_del %>%
  filter(genotype == "WT")

#wilcox test
w.del.b2.wt <- wilcox.test(b2$sum.length, wt$sum.length)
#w.del.b2.wt

### AMP: Wilcoxon Test

#BRCA1 vs WT
b1 <- plot_amp %>%
  filter(genotype == "B1", gene_deletion_status %in% c("BRCA1 del"))
wt <- plot_amp %>%
  filter(genotype == "WT")

#wilcox test
w.amp.b1.wt <- wilcox.test(b1$sum.length, wt$sum.length)
#w.amp.b1.wt

#BRCA2 vs WT
b2 <- plot_amp %>%
  filter(genotype == "B2", gene_deletion_status %in% c("BRCA2 del"))
wt <- plot_amp %>%
  filter(genotype == "WT")

#wilcox test
w.amp.b2.wt <- wilcox.test(b2$sum.length, wt$sum.length)
#w.amp.b2.wt

### Median Fold Change

#variables
del.b1 <- plot_del %>% filter(genotype == "B1", gene_deletion_status == "BRCA1 del")
del.b2 <- plot_del %>% filter(genotype == "B2", gene_deletion_status == "BRCA2 del")
del.wt <- plot_del %>% filter(genotype == "WT")
amp.b1 <- plot_amp %>% filter(genotype == "B1", gene_deletion_status == "BRCA1 del")
amp.b2 <- plot_amp %>% filter(genotype == "B2", gene_deletion_status == "BRCA2 del")
amp.wt <- plot_amp %>% filter(genotype == "WT")

#function to calculate fold change for tnbc CNV Deletions
compute_fold_change <- function(data_genotype1, data_genotype2) {
  median_genotype1 <- median(data_genotype1$sum.length, na.rm = TRUE)
  median_genotype2 <- median(data_genotype2$sum.length, na.rm = TRUE)
  
  # Calculate fold change
  fold_change <- median_genotype1 / median_genotype2  
  return(fold_change)
}

mfc <- data.frame(
  genotype = c("BRCA1", "BRCA2", "BRCA1", "BRCA2"),
  Event = c("Deletion", "Deletion", "Amplification", "Amplification"),
  Comparison = c("BRCA1 cells vs WT", "BRCA2 cells vs WT", "BRCA1 cells vs WT", "BRCA2 del vs WT"),
  Fold_Change = c(
    compute_fold_change(del.b1, del.wt),
    compute_fold_change(del.b2, del.wt),
    compute_fold_change(amp.b1, amp.wt),
    compute_fold_change(amp.b2, amp.wt)
  ),
 P_Value = c(p.adjust(p = w.del.b1.wt$p.value, method = "BH"),
             p.adjust(p = w.del.b2.wt$p.value, method = "BH"),
             p.adjust(p = w.amp.b1.wt$p.value, method = "BH"),
             p.adjust(p = w.amp.b2.wt$p.value, method = "BH"))
  )

#print df
 mfc %>%
  kbl(caption = "genotype: BRCA1/2 Deletion & Amplification Burden vs WT", digits = 10) %>%
  kable_classic(html_font = "Cambria") %>%
  kable_styling()
```

## *MFC: B2.16 Somatic BRCA Mutation*
```{r}
#Wilcoxon Test
#!!!!!!!!!!!!!

#BRCA1 vs WT
loh.16 <- plot_del %>%
  filter(sample == "B2.16", gene_deletion_status == "BRCA2 del")

het.16 <- plot_del %>%
    filter(sample == "B2.16", 
         gene_deletion_status %in% c("No del", "BRCA1 del"))

#wilcox test
w.b2.16.del <- wilcox.test(loh.16$sum.length, het.16$sum.length)
#loh.16

#BRCA1 vs WT
loh.16 <- plot_amp %>%
  filter(sample == "B2.16", gene_deletion_status == "BRCA2 del")

het.16 <- plot_amp %>%
    filter(sample == "B2.16", 
         gene_deletion_status %in% c("No del", "BRCA1 del"))

#wilcox test
w.b2.16.amp <- wilcox.test(loh.16$sum.length, het.16$sum.length)
#w.b2.16.amp 

#Median Fold Change
#!!!!!!!!!!!!!!!!!!

#variables
loh.16.del <- plot_del %>%
  filter(sample == "B2.16", gene_deletion_status == "BRCA2 del")

het.16.del <- plot_del %>%
  filter(sample == "B2.16", 
         gene_deletion_status %in% c("No del", "BRCA1 del"))

loh.16.amp <- plot_amp %>%
  filter(sample == "B2.16", gene_deletion_status == "BRCA2 del")

het.16.amp <- plot_amp %>%
    filter(sample == "B2.16", 
         gene_deletion_status %in% c("No del", "BRCA1 del"))

#function to calculate fold change for tnbc CNV Deletions
compute_fold_change <- function(data_genotype1, data_genotype2) {
  median_genotype1 <- median(data_genotype1$sum.length, na.rm = TRUE)
  median_genotype2 <- median(data_genotype2$sum.length, na.rm = TRUE)
  
  # Calculate fold change
  fold_change <- median_genotype1 / median_genotype2  
  return(fold_change)
}

mfc <- data.frame(
  genotype = c("BRCA2", "BRCA2"),
  Event = c("Deletion", "Amplification"),
  Comparison = c("LOH vs HET", "LOH vs HET"),
  Fold_Change = c(
    compute_fold_change(loh.16.del, het.16.del),
    compute_fold_change(loh.16.amp, het.16.amp)
    )
  ,
 FDR = c(p.adjust(p = w.b2.16.del$p.value, method = "BH"),
             p.adjust(p = w.b2.16.amp$p.value, method = "BH"))
  )

#print df
 mfc %>%
  kbl(caption = "genotype: BRCA1/2 Deletion & Amplification Burden vs WT", digits = 10) %>%
  kable_classic(html_font = "Cambria") %>%
  kable_styling()
```


## *MFC: (Benign)*
```{r}
### DEL: Wilcoxon Test

#benign only
cnd.ben <- df.cnd %>% filter(tissue == "benign")

#BRCA1 vs WT
b1 <- cnd.ben %>%
  filter(genotype == "B1")
wt <- cnd.ben %>%
  filter(genotype == "WT")

#wilcox test
w.del.b1.wt <- wilcox.test(b1$sum.length, wt$sum.length)
#w.del.b1.wt

#BRCA2 vs WT
b2 <- cnd.ben %>%
  filter(genotype == "B2")
wt <- cnd.ben %>%
  filter(genotype == "WT")

#wilcox test
w.del.b2.wt <- wilcox.test(b2$sum.length, wt$sum.length)
#w.del.b2.wt

### AMP: Wilcoxon Test

#benign only
cna.ben <- df.cna %>% filter(tissue == "benign")

#BRCA1 vs WT
b1 <- cna.ben %>%
  filter(genotype == "B1")
wt <- cna.ben %>%
  filter(genotype == "WT")

#wilcox test
w.amp.b1.wt <- wilcox.test(b1$sum.length, wt$sum.length)
#w.amp.b1.wt

#BRCA2 vs WT
b2 <- cna.ben %>%
  filter(genotype == "B2")
wt <- cna.ben %>%
  filter(genotype == "WT")

#wilcox test
w.amp.b2.wt <- wilcox.test(b2$sum.length, wt$sum.length)
#w.amp.b2.wt

### Median Fold Change

#variables
del.b1 <- cnd.ben%>% filter(genotype == "B1")
del.b2 <- cnd.ben %>% filter(genotype == "B2")
del.wt <- cnd.ben %>% filter(genotype == "WT")
amp.b1 <- cna.ben %>% filter(genotype == "B1")
amp.b2 <- cna.ben %>% filter(genotype == "B2")
amp.wt <- cna.ben %>% filter(genotype == "WT")

#function to calculate fold change for tnbc CNV Deletions
compute_fold_change <- function(data_genotype1, data_genotype2) {
  median_genotype1 <- median(data_genotype1$sum.length, na.rm = TRUE)
  median_genotype2 <- median(data_genotype2$sum.length, na.rm = TRUE)
  
  # Calculate fold change
  fold_change <- median_genotype1 / median_genotype2  
  return(fold_change)
}

mfc <- data.frame(
  genotype = c("BRCA1", "BRCA2", "BRCA1", "BRCA2"),
  Event = c("Deletion", "Deletion", "Amplification", "Amplification"),
  Comparison = c("BRCA1 cells vs WT", "BRCA2 cells vs WT", "BRCA1 cells vs WT", "BRCA2 del vs WT"),
  Fold_Change = c(
    compute_fold_change(del.b1, del.wt),
    compute_fold_change(del.b2, del.wt),
    compute_fold_change(amp.b1, amp.wt),
    compute_fold_change(amp.b2, amp.wt)
  ),
 P_Value = c(p.adjust(p = w.del.b1.wt$p.value, method = "BH"),
             p.adjust(p = w.del.b2.wt$p.value, method = "BH"),
             p.adjust(p = w.amp.b1.wt$p.value, method = "BH"),
             p.adjust(p = w.amp.b2.wt$p.value, method = "BH"))
  )

#print df
 mfc %>%
  kbl(caption = "Benign Tissue: BRCA1/2 Deletion & Amplification Burden vs WT", digits = 10) %>%
  kable_classic(html_font = "Cambria") %>%
  kable_styling()
```

## *MFC: (ALH)*
```{r}
### DEL: Wilcoxon Test

#alh only
cnd.alh <- df.cnd %>% filter(tissue == "ALH")

#BRCA2 vs WT
b2 <- cnd.alh %>%
  filter(genotype == "B2")
wt <- cnd.alh %>%
  filter(genotype == "WT")

#wilcox test
w.del.b2.wt <- wilcox.test(b2$sum.length, wt$sum.length)
#w.del.b2.wt

### AMP: Wilcoxon Test

#alh only
cna.alh <- df.cna %>% filter(tissue == "ALH")

#BRCA2 vs WT
b2 <- cna.alh %>%
  filter(genotype == "B2")
wt <- cna.alh %>%
  filter(genotype == "WT")

#wilcox test
w.amp.b2.wt <- wilcox.test(b2$sum.length, wt$sum.length)
#w.amp.b2.wt

### Median Fold Change

#variables
del.b2 <- cnd.alh %>% filter(genotype == "B2")
del.wt <- cnd.alh %>% filter(genotype == "WT")
amp.b2 <- cna.alh %>% filter(genotype == "B2")
amp.wt <- cna.alh %>% filter(genotype == "WT")

#function to calculate fold change for tnbc CNV Deletions
compute_fold_change <- function(data_genotype1, data_genotype2) {
  median_genotype1 <- median(data_genotype1$sum.length, na.rm = TRUE)
  median_genotype2 <- median(data_genotype2$sum.length, na.rm = TRUE)
  
  # Calculate fold change
  fold_change <- median_genotype1 / median_genotype2  
  return(fold_change)
}

mfc <- data.frame(
  genotype = c("BRCA2", "BRCA2"),
  Event = c("Deletion", "Amplification"),
  Comparison = c("BRCA2 cells vs WT", "BRCA2 del vs WT"),
  Fold_Change = c(
    compute_fold_change(del.b2, del.wt),
    compute_fold_change(amp.b2, amp.wt)
  ),
 P_Value = c(p.adjust(p = w.del.b2.wt$p.value, method = "BH"),
             p.adjust(p = w.amp.b2.wt$p.value, method = "BH"))
  )

#print df
 mfc %>%
  kbl(caption = "ALH Tissue: BRCA2 Deletion & Amplification Burden vs WT", digits = 10) %>%
  kable_classic(html_font = "Cambria") %>%
  kable_styling()
```